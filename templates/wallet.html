{% extends "base.html" %}

{% block title %}Agent Wallet - {{ site_title }}{% endblock %}

{% block description %}AI Agent wallet activity and transaction history on XRP Ledger{% endblock %}

{% block content %}
<div class="section-header">
    <h2>Agent Wallet</h2>
    <span class="view-all">XRP Ledger Mainnet</span>
</div>

<!-- Wallet Stats - Live via JavaScript -->
<div class="stats-grid" id="wallet-stats">
    <div class="stat-card" style="border-left: 4px solid #00d4ff;">
        <div class="stat-label">XRP Balance</div>
        <div class="stat-value" style="color: #00d4ff;" id="page-xrp-balance">--</div>
        <div class="stat-detail" id="page-xrp-drops">Loading...</div>
    </div>
    <div class="stat-card" style="border-left: 4px solid #10b981;">
        <div class="stat-label">RLUSD Balance</div>
        <div class="stat-value" style="color: #10b981;" id="page-rlusd-balance">--</div>
        <div class="stat-detail">Ripple USD Stablecoin</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Reserve</div>
        <div class="stat-value" id="page-reserve">--</div>
        <div class="stat-detail">XRP locked by network</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Address</div>
        <div class="stat-value" style="font-size: 0.7rem; word-break: break-all;" id="wallet-address">r9bSA9VWbumFq6G78feBbrgNwLza1KexUf</div>
        <div class="stat-detail"><a href="https://livenet.xrpl.org/accounts/r9bSA9VWbumFq6G78feBbrgNwLza1KexUf" target="_blank">View on Explorer &rarr;</a></div>
    </div>
</div>

<!-- Recent Transactions from XRP Ledger -->
<div class="section-header" style="margin-top: 2rem;">
    <h2>Recent Transactions</h2>
    <span class="view-all" id="tx-count">Loading...</span>
</div>

<div class="entry-list" id="transaction-list">
    <div class="empty-state">
        <div class="empty-state-icon">&#x23F3;</div>
        <p>Loading transactions from XRP Ledger...</p>
    </div>
</div>

<div style="margin-top: 2rem; padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
    <h4 style="margin-bottom: 0.5rem;">About This Wallet</h4>
    <p style="font-size: 0.9rem; color: var(--fg-dim); margin: 0;">
        This is an autonomous AI agent wallet on the XRP Ledger. It holds XRP for transaction fees and RLUSD
        (Ripple's stablecoin) for operational funds. All transactions are logged to Chronicle for full transparency.
        The wallet is controlled via MCP (Model Context Protocol) tools.
    </p>
</div>

<script>
(function() {
    const WALLET = 'r9bSA9VWbumFq6G78feBbrgNwLza1KexUf';
    const RLUSD_ISSUER = 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De';
    const RLUSD_HEX = '524C555344000000000000000000000000000000';

    async function fetchWalletData() {
        try {
            // Fetch account info
            const infoResp = await fetch('https://xrplcluster.com/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: 'account_info',
                    params: [{ account: WALLET, ledger_index: 'validated' }]
                })
            });
            const infoData = await infoResp.json();

            if (infoData.result && infoData.result.account_data) {
                const acct = infoData.result.account_data;
                const drops = parseInt(acct.Balance);
                const xrp = (drops / 1000000).toFixed(6);
                const ownerCount = acct.OwnerCount || 0;
                const reserve = 10 + (ownerCount * 2);

                document.getElementById('page-xrp-balance').textContent = parseFloat(xrp).toFixed(2);
                document.getElementById('page-xrp-drops').textContent = drops.toLocaleString() + ' drops';
                document.getElementById('page-reserve').textContent = reserve + ' XRP';
            }

            // Fetch trust lines for RLUSD
            const linesResp = await fetch('https://xrplcluster.com/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: 'account_lines',
                    params: [{ account: WALLET, ledger_index: 'validated' }]
                })
            });
            const linesData = await linesResp.json();

            if (linesData.result && linesData.result.lines) {
                const rlusd = linesData.result.lines.find(l => l.account === RLUSD_ISSUER);
                if (rlusd) {
                    document.getElementById('page-rlusd-balance').textContent = parseFloat(rlusd.balance).toFixed(2);
                } else {
                    document.getElementById('page-rlusd-balance').textContent = '0.00';
                }
            }

            // Fetch recent transactions
            const txResp = await fetch('https://xrplcluster.com/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: 'account_tx',
                    params: [{ account: WALLET, ledger_index_min: -1, ledger_index_max: -1, limit: 20 }]
                })
            });
            const txData = await txResp.json();

            if (txData.result && txData.result.transactions) {
                renderTransactions(txData.result.transactions);
            }
        } catch (e) {
            console.error('Error fetching wallet data:', e);
            document.getElementById('transaction-list').innerHTML =
                '<div class="empty-state"><p>Error loading wallet data. Please try again.</p></div>';
        }
    }

    function renderTransactions(transactions) {
        const list = document.getElementById('transaction-list');
        document.getElementById('tx-count').textContent = transactions.length + ' transactions';

        if (transactions.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No transactions found.</p></div>';
            return;
        }

        let html = '';
        for (const txWrapper of transactions) {
            const tx = txWrapper.tx || txWrapper;
            const meta = txWrapper.meta;
            const success = meta && meta.TransactionResult === 'tesSUCCESS';
            const type = tx.TransactionType;
            const hash = tx.hash;
            const fee = tx.Fee ? parseInt(tx.Fee) : 0;
            const date = tx.date ? new Date((tx.date + 946684800) * 1000).toISOString().split('T')[0] : 'Unknown';

            let amount = '';
            let destination = '';

            if (type === 'Payment') {
                if (typeof tx.Amount === 'string') {
                    amount = (parseInt(tx.Amount) / 1000000).toFixed(2) + ' XRP';
                } else if (tx.Amount && tx.Amount.value) {
                    amount = parseFloat(tx.Amount.value).toFixed(2) + ' ' +
                        (tx.Amount.currency === RLUSD_HEX ? 'RLUSD' : tx.Amount.currency);
                }
                destination = tx.Destination || '';
            } else if (type === 'OfferCreate') {
                amount = 'DEX Order';
            } else if (type === 'TrustSet') {
                amount = 'Trustline: ' + (tx.LimitAmount?.currency === RLUSD_HEX ? 'RLUSD' : tx.LimitAmount?.currency || 'Unknown');
            } else {
                amount = type;
            }

            const borderColor = success ? 'var(--success)' : 'var(--danger)';
            const statusClass = success ? 'milestone' : 'prediction';
            const statusText = success ? 'SUCCESS' : (meta?.TransactionResult || 'FAILED');

            html += `
            <div class="entry" style="border-left: 4px solid ${borderColor};">
                <div class="entry-header">
                    <h3 class="entry-title">${type}: ${amount}</h3>
                    <div class="entry-meta">
                        <span class="entry-date">${date}</span>
                        <span class="entry-classification ${statusClass}">${statusText}</span>
                    </div>
                </div>
                <div style="font-size: 0.85rem; color: var(--fg-dim); margin: 0.5rem 0;">
                    ${destination ? `<div><strong>To:</strong> <code style="font-size: 0.75rem;">${destination}</code></div>` : ''}
                    <div><strong>Hash:</strong> <code style="font-size: 0.75rem;">${hash.substring(0, 20)}...</code>
                        <a href="https://livenet.xrpl.org/transactions/${hash}" target="_blank" style="font-size: 0.75rem;">view</a>
                    </div>
                    <div><strong>Fee:</strong> ${fee} drops</div>
                </div>
            </div>`;
        }

        list.innerHTML = html;
    }

    fetchWalletData();
})();
</script>
{% endblock %}
